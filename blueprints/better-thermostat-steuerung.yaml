blueprint:
  name: Better Thermostat Steuerung
  author: d187
  homeassistant:
    min_version: "2024.10.0"
  description: >
    Dieses Modul dient als √ºbergeordnete Logik-Ebene, die die **Ziel-Temperatur**
    und den **HVAC-Modus** (heat/cool/auto oder off) basierend auf Anwesenheit und Zeitpl√§nen
    an die Better Thermostat (BT) Entit√§t(en) √ºbergibt.
    
    Alle weiteren Steuerungs- und Optimierungsfunktionen werden von Better Thermostat √ºbernommen.


    > Kernfunktionen:

    **Ziel-Temperatur** (Eco vs. Ziel) basierend auf Zeitpl√§nen.

    **Umschaltung auf Eco** bei Abwesenheit von Personen.

    **Frostschutz** als Mindesttemperatur-Override.
    
    **Automatisches Pausieren:** Die Steuerung pausiert, wenn BT oder eine externe Logik
    einen TRV auf den Modus `off` setzt. Sie nimmt die Steuerung automatisch wieder auf, 
    wenn der Modus wieder auf `heat`, `cool` oder `auto` gestellt wird.

    
    **WICHTIGER HINWEIS:**
    Globale Steuerungsparameter (Master-Schalter, Mindest-Au√üentemperatur etc.)
    sollten in der **Better Thermostat Integration** selbst konfiguriert werden.


    **Ziel-Entit√§t**: **Ihre Better Thermostat (BT) Klima-Entit√§t.**
  source_url: https://github.com/seebaer1976/home-assistant/blob/main/blueprints/trhs-steuerung.yaml
  domain: automation
  
  # INPUT-STRUKTUR
  input:
    thermostat_section:
      name: üî• Thermostat & HVAC-Modus
      icon: mdi:thermostat-box
      input:
        input_trvs:
          name: Better Thermostat (BT) Entit√§t
          description: >
            W√§hlen Sie die **virtuelle Better Thermostat (BT)** Klima-Entit√§t(en) (z.B. `climate.better_thermostat_wohnzimmer`), die Sie steuern m√∂chten.
          selector:
            entity:
              filter:
                - domain:
                    - climate
              multiple: true

        input_hvac_mode:
          name: Betrieb / HVAC-Modus
          description: >
            W√§hlen Sie den HVAC-Modus f√ºr Ihre BT-Entit√§t.
          default: "heat"
          selector:
            select:
              options:
                - heat
                - cool
                - auto
                - heat_cool

    temperature_section:
      name: üå°Ô∏è Ziel-Temperaturen & Frostschutz
      icon: mdi:thermometer-high
      collapsed: false
      input:
        input_temperature_comfort_static:
          name: ‚òÄÔ∏è Ziel-Temperatur (Statisch)
          description: >
            Die Ziel-Temperatur f√ºr den Komfort-Modus (Heizplan aktiv / Zuhause).
          default: 22
          selector:
            number:
              min: 12.0
              max: 86.0
              step: 0.5
              mode: box
              unit_of_measurement: ¬∞C / ¬∞F

        input_temperature_eco_static:
          name: üåô Eco-Temperatur (Statisch)
          description: >
            Die Temperatur, die eingestellt wird, wenn der Komfort-Modus nicht aktiv ist (z.B. nachts oder bei Abwesenheit).
          default: 19
          selector:
            number:
              min: 4.0
              max: 75.0
              step: 0.5
              mode: box
              unit_of_measurement: ¬∞C / ¬∞F
              
        input_frost_protection_temp:
          name: ‚ùÑÔ∏è Frostschutz-Temperatur
          description: >
            Temperatur, die eingestellt wird, wenn die errechnete Ziel-Temperatur niedriger als dieser Wert ist.
          default: 5
          selector:
            number:
              min: 5.0
              max: 62.0
              step: 0.5
              mode: box
              unit_of_measurement: ¬∞C / ¬∞F

        # Optionale Entit√§ten f√ºr dynamische Temperaturen
        input_temperature_comfort:
          name: Ziel-Temperatur (Entit√§t)
          description: >
            (Optional) Entit√§t (z.B. `input_number`) zur dynamischen Steuerung der Ziel-Temperatur.
          default: []
          selector:
            entity:
              filter:
                - domain:
                    - input_number
              multiple: false

        input_temperature_eco:
          name: Eco-Temperatur (Entit√§t)
          description: >
            (Optional) Entit√§t (z.B. `input_number`) zur dynamischen Steuerung der Eco-Temperatur.
          default: []
          selector:
            entity:
              filter:
                - domain:
                    - input_number
              multiple: false

    logic_section:
      name: üë§ Zeit- & Anwesenheitslogik
      icon: mdi:account-clock
      collapsed: false
      input:
        # Zeitplanung
        input_schedulers:
          name: üóìÔ∏è Zeitpl√§ne (Schedule Entit√§ten)
          description: >
            Ein [Zeitplan](https://www.home-assistant.io/integrations/schedule/) legt fest, wann auf Ziel-Temperatur geheizt werden soll.
          default: []
          selector:
            entity:
              filter:
                - domain:
                    - schedule
              multiple: true
              
        # Personen
        input_persons:
          name: üë• Abwesenheit-Personen
          description: >
            [Personen](https://www.home-assistant.io/integrations/person/) angeben. Wenn alle Personen **abwesend** sind, wird auf Eco-Temperatur umgeschaltet.
          default: []
          selector:
            entity:
              filter:
                - domain:
                    - person
              multiple: true

        input_people_entering_home_duration:
          name: Ankunfts-Verz√∂gerung
          description: >
            Dauer, die jemand zuhause sein muss, bevor der Ziel-Modus aktiv wird.
          default:
            hours: 0
            minutes: 0
            seconds: 2
          selector:
            duration:

        input_people_leaving_home_duration:
          name: Abwesenheits-Verz√∂gerung
          description: >
            Dauer, die jemand abwesend sein muss, bevor auf Eco-Temperatur umgeschaltet wird.
          default:
            hours: 0
            minutes: 0
            seconds: 2
          selector:
            duration:

variables:
  # Thermostate / Sensoren
  input_trvs: !input input_trvs

  # Personen
  input_persons: !input input_persons
  input_people_entering_home_duration: !input input_people_entering_home_duration
  input_people_leaving_home_duration: !input input_people_leaving_home_duration

  input_person_count: "{{ input_persons | count }}"
  is_person_defined: "{{ input_person_count > 0 }}"

  # Zeitplaner
  input_schedulers: !input input_schedulers

  # Temperaturen
  input_temperature_comfort: !input input_temperature_comfort
  input_temperature_eco: !input input_temperature_eco
  input_hvac_mode: !input input_hvac_mode
  factor: "{{ iif(input_hvac_mode == 'cool', -1, 1) | int }}"

  # Frostschutz
  input_frost_protection_temp: !input input_frost_protection_temp

  # Personenzustand
  person_states: >
    {% set p_states = namespace(persons = []) %}
    {% for person in input_persons %}
      {% if states(person) == 'home' %}
        {% set p_states.persons = p_states.persons + ['home'] %}
      {% else %}
        {% set p_states.persons = p_states.persons + ['not_home'] %}
      {% endif %}
      {% if now() - as_datetime(states[person].last_changed) < input_people_entering_home_duration and states(person) == 'home' %}
        {% set p_states.persons = p_states.persons + ['just_arrived'] %}
      {% endif %}
    {% endfor %}
    {{ p_states.persons }}

  # Anzahl der Personen zuhause
  people_home_count: "{{ person_states | select('equalto', 'home') | list | count }}"
  is_people_home: "{{ people_home_count > 0 }}"
  is_someone_just_arrived: "{{ person_states | select('equalto', 'just_arrived') | list | count > 0 }}"

  # Ziel-Temperatur (statisch oder Entit√§t)
  comfort_temp: >
    {% set temp_value = state_attr(input_temperature_comfort, 'state') | default(states(input_temperature_comfort), true) | default(namespace(s = 0)) %}
    {% if temp_value.s == 0 %}
      {{ input_temperature_comfort_static | float }}  
    {% else %}
      {{ temp_value | float }}
    {% endif %}

  # Eco-Temperatur (statisch oder Entit√§t)
  eco_temp: >
    {% set temp_value = state_attr(input_temperature_eco, 'state') | default(states(input_temperature_eco), true) | default(namespace(s = 0)) %}
    {% if temp_value.s == 0 %}
      {{ input_temperature_eco_static | float }}
    {% else %}
      {{ temp_value | float }}
    {% endif %}

  # Heizplan-Aktivit√§t
  is_scheduler_active: >
    {% set result = false %}
    {% if input_schedulers == [] %}
      {% set result = true %}
    {% else %}
      {% for scheduler in input_schedulers %}
        {% if states(scheduler) == 'on' %}
          {% set result = true %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {{ result }}

  # Modus (comfort/eco)
  mode: >
    {% set result = 'eco' %}
    
    {% if is_scheduler_active %}
      {% set result = 'comfort' %}
    {% endif %}

    # Abwesenheit-Logik
    {% if is_person_defined and not is_people_home and result == 'comfort' %}
      {% set result = 'eco' %}
    {% endif %}
    
    {{ result }}

  # Zieltemperatur
  temp_target: >
    {% set result = eco_temp | float %}

    # Ziel-Modus
    {% if mode == 'comfort' %}
      {% set result = comfort_temp | float %}
    # Eco-Modus
    {% elif mode == 'eco' %}
      {% set result = eco_temp | float %}
    {% endif %}

    # Rundung und Minimaltemperatur
    {% set result = (result * 2) | round / 2 %}
    {% if result < 4.0 %}
      {% set result = 4.0 %}
    {% endif %}
    {{ result }}

  # HVAC-Modus
  hvac_mode: >
    {% set mode_map = {'eco': input_hvac_mode, 'comfort': input_hvac_mode} %}
    {% set result = mode_map[mode] %}
    {{ result }}

  # Frostschutz
  is_frost_protection_active: >
    {% set result = false %}
    {% if temp_target < input_frost_protection_temp %}
      {% set result = true %}
    {% endif %}
    {{ result }}

  temp_target_with_frost: "{{ iif(is_frost_protection_active and input_hvac_mode == 'heat', input_frost_protection_temp | float, temp_target | float) }}"

  # Alle Entit√§ten, deren Zustand eine Ausl√∂sung bewirken kann.
  listen_entities: >
    {{ input_trvs + input_persons + input_schedulers + [input_temperature_comfort] + [input_temperature_eco] | reject('equalto', none) | list }}

  # Alle Temperatursensoren, deren Zustand eine Ausl√∂sung bewirken kann.
  listen_temp_entities: >
    {{ input_trvs | reject('equalto', none) | list }}


# Trigger

trigger:
  # 1. Start-Trigger
  - platform: homeassistant
    event: start
    id: startup

  # 2. Ausl√∂ser f√ºr √Ñnderungen des Thermostat-Zustands
  - platform: state
    entity_id: "{{ input_trvs }}"
    attribute: temperature
    not_to:
      - "{{ temp_target_with_frost }}"
    id: trv_temp_change

  # 3. Ausl√∂ser f√ºr √Ñnderungen des HVAC-Modus des Thermostats
  - platform: state
    entity_id: "{{ input_trvs }}"
    attribute: hvac_mode
    id: trv_hvac_mode_change

  # 4. Ausl√∂ser f√ºr √Ñnderungen anderer relevanter Entit√§ten
  - platform: state
    entity_id: "{{ listen_entities }}"
    id: other_entity_change

  # 5. Ausl√∂ser f√ºr √Ñnderungen des Temperatursensors (nur BT-Sensor)
  - platform: state
    entity_id: "{{ listen_temp_entities }}"
    id: temp_entity_change

  # 6. Zeitgesteuerter Ausl√∂ser f√ºr Zeitplan-Anpassungen (jede Minute)
  - platform: time_pattern
    minutes: /1
    id: time_change

  # 7. Personen-Anwesenheits-Trigger
  - platform: state
    entity_id: !input input_persons
    to: "home"
    for: !input input_people_entering_home_duration
    id: person_entering_home

  # 8. Personen-Abwesenheits-Trigger
  - platform: state
    entity_id: !input input_persons
    to: "not_home"
    for: !input input_people_leaving_home_duration
    id: person_leaving_home


# Aktion
action:
  # Hauptlogik: BT-Entit√§t steuern
  - variables:
      changes_to_apply: >
        {% set changes = namespace(trvs = []) %}
        {% for thermostat in input_trvs %}
          {% set current_temp = state_attr(thermostat, 'temperature') %}
          {% set current_hvac_mode = states(thermostat) %}
          
          {% if current_hvac_mode != hvac_mode %}
            {% set changes.trvs = changes.trvs + [thermostat] %}
          {% elif current_temp | float != temp_target_with_frost | float and hvac_mode != 'off' %}
            {% set changes.trvs = changes.trvs + [thermostat] %}
          {% endif %}
        {% endfor %}
        {{ changes.trvs | unique | list }}

  - if:
      - condition: template
        value_template: "{{ changes_to_apply | count | int > 0 }}"
    then:
      # Protokollierung der √Ñnderungen
      - service: logbook.log
        data:
          name: "Klima-Steuerung"
          message: "Modus: {{ mode }}, Zieltemperatur: {{ temp_target_with_frost }}, HVAC: {{ hvac_mode }}, √Ñnderungen an {{ changes_to_apply | count }} BT-Entit√§ten."
          entity_id: "{{ this.entity_id }}"

      # Variablen f√ºr die Schleife festlegen (werden au√üerhalb des repeat-Blocks global definiert)
      - variables:
          mode: "{{ hvac_mode }}"
          temp_target: "{{ temp_target_with_frost }}"

      - repeat:
          for_each: "{{ changes_to_apply }}"
          sequence:
            
            # *** NEUE LOGIK: BT-Off-Override (Respektiert externes 'off') ***
            - if:
                - condition: template
                  value_template: >
                    {# Pr√ºft, ob der TRV aktuell auf 'off' ist (extern gesetzt) und die Automation
                       eigentlich 'heat/cool' m√∂chte. Wenn ja, wird die Steuerung pausiert. #}
                    {% set current_hvac = states(repeat.item) | lower %}
                    {% set desired_hvac = mode | lower %}
                    {{ current_hvac == 'off' and desired_hvac in ['heat', 'cool', 'auto', 'heat_cool'] }}
              then:
                - service: logbook.log
                  data:
                    name: "Klima-Steuerung"
                    message: "BT-Entit√§t {{ repeat.item }} ist extern auf 'off' gesetzt. Steuerung pausiert, um manuelles/globales Abschalten zu respektieren."
                    entity_id: "{{ this.entity_id }}"
                - continue: true
              
            # Setze HVAC-Modus
            - if:
                - condition: template
                  value_template: "{{ states(repeat.item) | lower != mode | lower  }}"
              then:
                - service: climate.set_hvac_mode
                  data:
                    entity_id: "{{ repeat.item }}"
                    hvac_mode: "{{ mode }}"

            # Setze Temperatur
            - if:
                - condition: template
                  value_template: "{{ state_attr(repeat.item, 'temperature') != temp_target and mode != 'off' }}"
              then:
                - service: climate.set_temperature
                  data:
                    entity_id: "{{ repeat.item }}"
                    temperature: "{{ temp_target | float }}"

mode: queued
